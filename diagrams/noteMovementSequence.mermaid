sequenceDiagram
    participant Client1 as Client 1
    participant Client2 as Client 2
    participant Gateway as Socket Gateway
    participant RoomCache as Redis Room Cache
    participant RedisPubSub as Redis Pub/Sub
    participant NotesService as Notes Service
    participant DB as PostgreSQL

    Note over Client1,DB: Client 1 передвигает заметку на canvas
    Client1->>Gateway: emit('note:move', {<br/>  noteId: 'note-123',<br/>  position: {x: 300, y: 400}<br/>})

    Note over Gateway: Gateway знает userId и roomId<br/>из socketToUser map

    Gateway->>RedisPubSub: PUBLISH events:gateway<br/>{<br/>  eventType: 'note:move',<br/>  userId: 'clientA',<br/>  socketId: 'sock-abc123',<br/>  roomId: 'room123',<br/>  payload: {<br/>    noteId: 'note-123',<br/>    position: {x: 300, y: 400}<br/>  },<br/>  timestamp: 1234567890000<br/>}

    Note over NotesService: Notes Service подписан<br/>на events:gateway

    RedisPubSub->>NotesService: events:gateway message

    Note over NotesService: Обработчик handleNoteMove()

    NotesService->>NotesService: Найти заметку:<br/>notesStore.get('note-123')

    NotesService->>NotesService: Обновить позицию:<br/>note.position = {x: 300, y: 400}<br/>note.updatedAt = Date.now()

    Note over NotesService: In-memory update<br/>(можно сохранить в DB)

    opt Опционально: сохранение в БД
        NotesService->>DB: UPDATE notes<br/>SET position = {x: 300, y: 400}<br/>WHERE id = 'note-123'
        DB-->>NotesService: OK
    end

    Note over NotesService: Возврат результата<br/>с ПУСТЫМ recipients

    NotesService->>RedisPubSub: PUBLISH events:broadcast<br/>{<br/>  type: 'note:moved',<br/>  recipients: [],<br/>  payload: {<br/>    noteId: 'note-123',<br/>    position: {x: 300, y: 400},<br/>    userId: 'clientA'<br/>  }<br/>}

    Note over Gateway: Gateway подписан<br/>на events:broadcast

    RedisPubSub->>Gateway: events:broadcast message

    Note over Gateway: recipients пустой →<br/>получить из Room Cache

    Gateway->>RoomCache: HGETALL room:room123

    RoomCache-->>Gateway: {<br/>  'clientA': 'sock-abc123',<br/>  'clientB': 'sock-def456'<br/>}

    Note over Gateway: Формирование списка<br/>получателей для broadcast

    Gateway->>Client1: emit('note:moved', {<br/>  noteId: 'note-123',<br/>  position: {x: 300, y: 400},<br/>  userId: 'clientA'<br/>})

    Gateway->>Client2: emit('note:moved', {<br/>  noteId: 'note-123',<br/>  position: {x: 300, y: 400},<br/>  userId: 'clientA'<br/>})

    Note over Client1: Client1 получает<br/>подтверждение своего действия<br/>(может игнорировать,<br/>т.к. userId === 'clientA')

    Note over Client2: Client2 видит<br/>обновление позиции заметки<br/>в реальном времени ✓

    Note over Client1,DB: Результат: Заметка перемещена, оба клиента синхронизированы
